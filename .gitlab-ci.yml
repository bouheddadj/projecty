image: maven:3-eclipse-temurin-21-alpine

stages:
  - build
  - deploy

variables:
  API_DEPLOY_PATH: "/opt/tomcat/webapps/users.war"

before_script:
  - chmod +x ci/setup-mvn-proxy.sh
  - ci/setup-mvn-proxy.sh

  # Sécuriser la clé SSH
  - chmod 400 $CI_SSH_KEY

  # Installer les outils nécessaires
  - apk add --no-cache openssh-client rsync

# Build API-USERS
build_api:
  stage: build
  only:
    - main # Limiter ce job à la branche main
  script:
    # Se placer dans le répertoire tp6 (API)
    - cd ./users
    # Compiler et packager l'API
    - mvn clean package
  artifacts:
    paths:
      - users/target/users.war # Conserver le fichier WAR pour l'étape de déploiement

# Build CLIENT
build&deploy_client:
  stage: build
  only:
    - main
  image: node:23-slim
  before_script:
    - apt-get update && apt-get install -y openssh-client rsync
    - chmod 400 $CI_SSH_KEY
  script:
    - cd client
    - npm install
    - npm run build
    - scp -r -o StrictHostKeyChecking=no -i $CI_SSH_KEY ./client/dist/* gitlabci@192.168.75.33:/usr/share/nginx/html/client

# Deploy API-USERS
deploy_api_users:
  stage: deploy
  only:
    - main
  script:
    - scp -o StrictHostKeyChecking=no -i $CI_SSH_KEY users/target/users.war gitlabci@192.168.75.33:$API_DEPLOY_PATH

# Deploy Express Server TEST
deploy_test_express:
  stage: deploy
  only:
    - main
  script:
    - scp -r -o StrictHostKeyChecking=no -i $CI_SSH_KEY ./express/* gitlabci@192.168.75.33:/opt/express
    - ssh -o StrictHostKeyChecking=no -i $CI_SSH_KEY gitlabci@192.168.75.33 "
      cd /opt/express
      && pm2 stop server.js || true
      && npm install
      && pm2 restart server.js"

# # Deploy API-GAME
deploy_api_game:
  stage: deploy
  only:
    - main
  before_script:
    - apk add --no-cache openssh-client rsync
    - chmod 400 $CI_SSH_KEY
  script:
    - scp -r -o StrictHostKeyChecking=no -i $CI_SSH_KEY ./api/* gitlabci@192.168.75.33:/opt/api-game

    - echo "$ENV_PRODUCTION_API_GAME" > temp.env

    - scp -o StrictHostKeyChecking=no -i $CI_SSH_KEY temp.env gitlabci@192.168.75.33:/opt/api-game/.env.production

    - ssh -o StrictHostKeyChecking=no -i $CI_SSH_KEY gitlabci@192.168.75.33 "
      cd /opt/api-game &&
      pm2 delete api-game || true &&
      npm install &&
      pm2 start ecosystem.config.js --env production &&
      pm2 save
      "

# Deploy ADMIN-CLIENT
deploy_admin:
  stage: deploy
  only:
    - main
  image: node:23-slim
  before_script:
    - apt-get update && apt-get install -y openssh-client rsync
    - chmod 400 $CI_SSH_KEY
  script:
    - cd admin
    - echo "$ENV_PRODUCTION_ADMIN" > .env.production
    - npm install
    - npm install dotenv --save-dev
    - npm run build
    - scp -r -o StrictHostKeyChecking=no -i $CI_SSH_KEY dist/* gitlabci@192.168.75.33:/usr/share/nginx/html/secret/

# Deploy front-end
deploy_front:
  stage: deploy
  only:
    - main
  script:
    - scp -r -o StrictHostKeyChecking=no -i $CI_SSH_KEY ./client/index.html gitlabci@192.168.75.33:/usr/share/nginx/html
